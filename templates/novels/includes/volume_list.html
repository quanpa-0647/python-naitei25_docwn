{% load i18n %}
{% load status_filters %}

{% for volume in volumes %}
  {% if volume.chapter_list %}
  <div id="volume{{ forloop.counter }}" class="volume-box">
    <h3 class="volume-title">{{ volume.name }}</h3>

    <div class="volume-content">
      <div class="volume-cover">
        {% if novel.image_url %}
          <img src="{{ novel.image_url }}" alt="{{ volume.name }}">
        {% else %}
          <div class="novel-image-placeholder volume-cover-placeholder">
            <i class="bx bx-book"></i>
          </div>
        {% endif %}
      </div>

      <div class="chapter-list">
        {% with chapter_list=volume.chapter_list %}
          {% for chapter in chapter_list %}
            {% if forloop.counter <= MAX_CHAPTER_LIST %}
              <div id="chapter-{{ chapter.slug }}" class="chapter-item">
                <div class="chapter-content">
                  {% if chapter.rejected_reason %}
                    <span class="chapter-link-disabled" data-tooltip="{% trans 'Lý do từ chối:' %} {{ chapter.rejected_reason }}">
                      {{ chapter.title }}
                      <i class="bx bx-lock text-muted"></i>
                    </span>
                  {% else %}
                    <a href="{% url 'novels:chapter_detail' novel_slug=novel.slug chapter_slug=chapter.slug %}">
                      {{ chapter.title }}
                      {% if not chapter.approved %}
                        <span class="badge badge-warning">{% trans "Chờ duyệt" %}</span>
                      {% elif chapter.is_hidden %}
                        <span class="badge badge-secondary">{% trans "Ẩn" %}</span>
                      {% endif %}
                    </a>
                  {% endif %}
                  <div class="chapter-meta">
                    <span class="chapter-date">{{ chapter.created_at|date:DATE_FORMAT_DMY }}</span>
                    {% if is_owner %}
                      <span class="chapter-status {{ chapter|chapter_status_class }}">
                        <i class="bx {{ chapter|chapter_status_icon }}"></i>
                        {{ chapter|chapter_status_label }}
                      </span>
                    {% endif %}
                  </div>
                </div>
                {% if is_owner %}
                  <div class="chapter-actions">
                    <button type="button" 
                            class="btn-delete-chapter" 
                            data-chapter-slug="{{ chapter.slug }}"
                            data-chapter-title="{{ chapter.title }}"
                            data-novel-slug="{{ novel.slug }}"
                            title="{% trans 'Xóa chapter' %}">
                      <i class="bx bx-trash"></i>
                    </button>
                  </div>
                {% endif %}
              </div>
            {% elif forloop.counter == MAX_CHAPTER_LIST_PLUS %}
              <div id="extraChapters{{ volume.id }}" class="chapter-extra hidden">
                <div id="chapter-{{ chapter.slug }}" class="chapter-item">
                  <div class="chapter-content">
                    {% if chapter.rejected_reason %}
                      <span class="chapter-link-disabled" data-tooltip="{% trans 'Lý do từ chối:' %} {{ chapter.rejected_reason }}">
                        {{ chapter.title }}
                        <i class="bx bx-lock text-muted"></i>
                      </span>
                    {% else %}
                      <a href="{% url 'novels:chapter_detail' novel_slug=novel.slug chapter_slug=chapter.slug %}">
                        {{ chapter.title }}
                        {% if not chapter.approved %}
                          <span class="badge badge-warning">{% trans "Chờ duyệt" %}</span>
                        {% elif chapter.is_hidden %}
                          <span class="badge badge-secondary">{% trans "Ẩn" %}</span>
                        {% endif %}
                      </a>
                    {% endif %}
                    <div class="chapter-meta">
                      <span class="chapter-date">{{ chapter.created_at|date:DATE_FORMAT_DMY }}</span>
                      {% if is_owner %}
                        <span class="chapter-status {{ chapter|chapter_status_class }}">
                          <i class="bx {{ chapter|chapter_status_icon }}"></i>
                          {{ chapter|chapter_status_label }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  {% if is_owner %}
                    <div class="chapter-actions">
                      <button type="button" 
                              class="btn-delete-chapter" 
                              data-chapter-slug="{{ chapter.slug }}"
                              data-chapter-title="{{ chapter.title }}"
                              data-novel-slug="{{ novel.slug }}"
                              title="{% trans 'Xóa chapter' %}">
                        <i class="bx bx-trash"></i>
                      </button>
                    </div>
                  {% endif %}
                </div>
            {% else %}
                <div id="chapter-{{ chapter.slug }}" class="chapter-item">
                  <div class="chapter-content">
                    {% if chapter.rejected_reason %}
                      <span class="chapter-link-disabled" data-tooltip="{% trans 'Lý do từ chối:' %} {{ chapter.rejected_reason }}">
                        {{ chapter.title }}
                        <i class="bx bx-lock text-muted"></i>
                      </span>
                    {% else %}
                      <a href="{% url 'novels:chapter_detail' novel_slug=novel.slug chapter_slug=chapter.slug %}">
                        {{ chapter.title }}
                        {% if not chapter.approved %}
                          <span class="badge badge-warning">{% trans "Chờ duyệt" %}</span>
                        {% elif chapter.is_hidden %}
                          <span class="badge badge-secondary">{% trans "Ẩn" %}</span>
                        {% endif %}
                      </a>
                    {% endif %}
                    <div class="chapter-meta">
                      <span class="chapter-date">{{ chapter.created_at|date:DATE_FORMAT_DMY }}</span>
                      {% if is_owner %}
                        <span class="chapter-status {{ chapter|chapter_status_class }}">
                          <i class="bx {{ chapter|chapter_status_icon }}"></i>
                          {{ chapter|chapter_status_label }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  {% if is_owner %}
                    <div class="chapter-actions">
                      <button type="button" 
                              class="btn-delete-chapter" 
                              data-chapter-slug="{{ chapter.slug }}"
                              data-chapter-title="{{ chapter.title }}"
                              data-novel-slug="{{ novel.slug }}"
                              title="{% trans 'Xóa chapter' %}">
                        <i class="bx bx-trash"></i>
                      </button>
                    </div>
                  {% endif %}
                </div>
            {% endif %}
          {% endfor %}

          {% if chapter_list|length > MAX_CHAPTER_LIST %}
            </div>
            <div class="see-more">
              <a href="javascript:void(0)" class="toggleChapters"
                data-target="extraChapters{{ volume.id }}"
                data-text-show="{% trans 'Xem tiếp' %}"
                data-text-hide="{% trans 'Ẩn bớt' %}"
                data-unit="{% trans 'chương' %}">
                {% trans "Xem tiếp:" %} ({{ volume.remaining_chapters }} {% trans "chương" %})
              </a>
            </div>
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
  {% endif %}
{% endfor %}

{% if can_add_chapter %}
  <div class="add-chapter-section">
    <a href="{% url 'novels:chapter_add' novel_slug=novel.slug %}" class="btn btn-primary add-chapter-btn">
      <i class="fas fa-plus"></i> {% trans "Thêm Chapter" %}
    </a>
  </div>
{% endif %}

<!-- Chapter Delete Confirmation Modal -->
{% if is_owner %}
<div id="deleteChapterModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Xác nhận xóa chapter" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Đóng' %}"></button>
      </div>
      <div class="modal-body">
        <p>{% trans "Bạn có chắc chắn muốn xóa chapter" %} "<span id="deleteChapterTitle"></span>" {% trans "không?" %}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          {% trans "Hủy" %}
        </button>
        <form id="deleteChapterForm" method="post" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            {% trans "Xóa chapter" %}
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}
